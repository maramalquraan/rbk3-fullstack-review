"use strict";function t(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function i(t){return w(t)&&m(t.settle)&&m(t.map)&&m(t.mapResult)&&m(t.mapError)&&m(t.deinit)}function n(t){t.b||(t.b=!0,t.asap.call(null,t.c))}function e(t){t.b=!1,t.tick()}function o(t,i,n){return i?t(i):n}function r(t,i,n){if(i)throw i;return t(n)}function s(t,i,n){t.f=void 0,t.settle(i||n)}function h(t,i,n){t.f=void 0,t.settle(i,n)}function u(t,i){if(!C(t,G))throw i;t.settle(i)}function f(t,i){t.g=void 0,i.f=void 0}function c(t,i){t.g=i,i.f=t,T(t,B),N(t,J),x(t,G)&&v(t)}function a(t){return T(t,B),N(t,J),t.e}function l(t,i){T(t,B),N(t,J),t.i=i}function d(t,i,n){t.map(function(t,e){t?n(t):i(e)})}function v(t){(t.constructor.scheduler||K.scheduler).push(t)}function p(t){return w(t)&&m(t.deinit)}function m(t){return"function"==typeof t}function y(t){return w(t)&&t instanceof Array}function w(t){return null!=t&&"object"==typeof t}function b(t){return w(t)&&m(t.then)}function g(t,i){if(!t(i))throw Error("Expected "+i+" to satisfy test "+t.name)}function E(t,i){throw t||i}function k(){return Error("Expected a consumable future (one that has not been averted or mapped)")}function P(t){p(t)&&t.deinit()}function j(t){try{for(;t.length;)t.shift().deinit()}catch(i){throw j(t),i}}function R(t){for(var n=null,e=-1;++e<t.length;){var o=t[e];if(i(o))try{o.deinit()}catch(t){n=t}}if(n)throw n}function C(t,i){return 0!=(t.d&i)}function x(t,i){return 0==(t.d&i)}function N(t,i){t.d|=i}function T(t,i){t.d&=~i}function A(t,i){t.d=t.d&z|i}function M(t){if("undefined"==typeof self&&"object"==typeof process&&process&&process.nextTick)return process.nextTick;if("function"==typeof MessageChannel){var i=new MessageChannel;return i.port1.onmessage=t,function(){i.port2.postMessage(null)}}return setTimeout}var S=function(){function t(t,i){for(var n=0;n<i.length;n++){var e=i[n];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,n,e){return n&&t(i.prototype,n),e&&t(i,e),i}}(),D=require("fastqueue");exports.isFuture=i;var I=function(){function i(){t(this,i),this.a=new D,this.b=!1,this.c=e.bind(null,this),this.asap=M(this.c)}return i.prototype.push=function(t){this.a.push(t),this.a.length&&n(this)},i.prototype.tick=function(){try{for(;this.a.length;)this.a.shift().finishPending()}finally{this.a.length&&n(this)}},i.prototype.deinit=function(){this.a=new D},i}();exports.Scheduler=I;var O=0,G=1,q=2,F=4,U=8,B=16,J=32,V=64,_=255,z=_^(G|q|F|U),H=U|J,K=function(){function n(){t(this,n),this.d=G,this.e=void 0,this.f=void 0,this.g=void 0,this.h=void 0,this.i=void 0,this.j=void 0,this.k=void 0}return n.prototype.deref=function(){if(C(this,q))throw T(this,B),this.e;return this.e},n.prototype.settle=function(t,e){if(!x(this,G)&&!C(this,V)){if(t===this||e===this)throw Error("A future can't be chained to itself");if(this.k=void 0,t&&i(e))return void this.settle(t);if(i(t))return t instanceof n?C(t,H)?void this.settle(k()):(c(t,this),void(this.i=E)):void(this.f=t.map(s.bind(null,this)));if(i(e))return e instanceof n?C(e,H)?void this.settle(k()):void c(e,this):void(this.f=e.map(h.bind(null,this)));var o=this.i;if(this.i=void 0,m(o)){N(this,V);var r=void 0;try{r=o(t,e),T(this,V)}catch(t){return T(this,V),void u(this,t)}return void this.settle(void 0,r)}if(A(this,t?q:F),this.e=t||e,this.g||this.h)return void v(this);t&&(N(this,B),v(this))}},n.prototype.map=function(t){if(g(m,t),C(this,H))throw k();var i=new this.constructor;return c(this,i),i.i=t,i},n.prototype.mapError=function(t){return g(m,t),this.map(o.bind(null,t))},n.prototype.mapResult=function(t){return g(m,t),this.map(r.bind(null,t))},n.prototype.toPromise=function(){return T(this,B),C(this,q)?Promise.reject(this.e):C(this,F)?Promise.resolve(this.e):new Promise(d.bind(null,this))},n.prototype.catch=function(){var t;return(t=this.toPromise()).catch.apply(t,arguments)},n.prototype.then=function(){var t;return(t=this.toPromise()).then.apply(t,arguments)},n.prototype.weak=function(){if(C(this,U))throw Error("Can't create a .weak() branch from an averted future");var t=this.constructor;if(C(this,q))return t.fromError(this.e);if(C(this,F))return t.fromResult(this.e);this.h||(this.h=new D);var i=new t;return this.h.push(i),i},n.prototype.finishPending=function(){if(this.j){var t=this.j;this.j=void 0;try{this.k=t(this)}catch(t){u(this,t)}}var i=this.g;i&&(C(this,q)?(f(this,i),i.settle(this.e)):C(this,F)&&(f(this,i),i.settle(void 0,this.e)));var n=this.h;if(n)if(C(this,q))for(;n.length;)n.shift().settle(this.e);else if(C(this,F))for(;n.length;)n.shift().settle(void 0,this.e);C(this,B)&&(T(this,B),C(this,q)&&this.constructor.handleRejection(this))},n.prototype.deinit=function(){if(!C(this,U)&&!C(this,V)){this.d=U,this.j=void 0,this.i=void 0;try{var t=this.k;this.k=void 0,m(t)&&t()}finally{try{var i=this.f;this.f=void 0,i&&i.deinit()}finally{try{var n=this.g;this.g=void 0,n&&n.deinit()}finally{var e=this.h;this.h=void 0,e&&j(e,P)}}}}},n.init=function(t){g(m,t);var i=new this;try{i.k=t(i)}catch(t){u(i,t)}return i},n.initAsync=function(t){g(m,t);var i=new this;return i.j=t,v(i),i},n.from=function(t,i){var n=new this;return n.settle(t,i),n},n.fromError=function(t){return g(Boolean,t),this.from(t)},n.fromResult=function(t){return i(t)?t:this.from(void 0,t)},n.fromPromise=function(t){g(b,t);var i=new this;return t.then(i.settle.bind(i,void 0),i.settle.bind(i)),i},n.all=function(t){return g(y,t),t.length?new L(new this,t.slice()).l:this.fromResult([])},n.race=function(t){return g(y,t),new Q(new this,t.slice()).l},n.handleRejection=function(t){throw t.e},S(n,[{key:"state",get:function(){return{PENDING:C(this,G),ERROR:C(this,q),SUCCESS:C(this,F),AVERTED:C(this,U),PENDING_REJECTION:C(this,B),CONSUMED:C(this,J),MAPPING:C(this,V)}}}]),n}();K.scheduler=new I,exports.Future=K;var L=function(){function n(e,o){t(this,n),this.l=e,this.m=o,e.k=this.n.bind(this);for(var r=-1;++r<o.length;){var s=o[r];if(i(s)){if(s instanceof K){if(C(s,q))return void this.o(r,a(s));if(C(s,F)){o[r]=a(s);continue}if(!s.i){l(s,this.o.bind(this,r));continue}}o[r]=s.map(this.o.bind(this,r))}}this.p()}return n.prototype.o=function(t,i,n){var e=this.m;if(e){if(i)return e[t]=void 0,this.l.settle(i),void this.n();e[t]=n,this.p()}},n.prototype.p=function(){var t=this.m;t.some(i)||(this.m=void 0,this.l.settle(void 0,t))},n.prototype.n=function(){var t=this.m;this.m=void 0,t&&R(t)},n}(),Q=function(){function n(e,o){t(this,n),this.l=e,this.m=o,e.k=this.n.bind(this);for(var r=-1;++r<o.length;){var s=o[r];if(!i(s))return void this.o(r,void 0,s);if(s instanceof K){if(C(s,q))return void this.o(r,a(s));if(C(s,F))return void this.o(r,void 0,a(s));if(!s.i){l(s,this.o.bind(this,r));continue}}o[r]=s.map(this.o.bind(this,r))}}return n.prototype.o=function(t,i,n){this.m&&(this.m[t]=void 0,this.l.settle(i,n),this.n())},n.prototype.n=function(){var t=this.m;this.m=void 0,t&&R(t)},n}();